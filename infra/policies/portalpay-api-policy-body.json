{
  "properties": {
    "format": "rawxml",
    "value": "<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<policies>\n  <inbound>\n    <base />\n    <choose>\n      <!-- Always-OK health check for AFD and direct APIM -->\n      <when condition='@(context.Request.OriginalUrl.Path.ToLower().Contains(\"/portalpay/healthz\"))'>\n        <return-response>\n          <set-status code=\"200\" reason=\"OK\" />\n          <set-header name=\"Content-Type\" exists-action=\"override\">\n            <value>application/json</value>\n          </set-header>\n          <set-body>{\"status\":\"ok\"}</set-body>\n        </return-response>\n      </when>\n\n      <!-- Allow either: valid APIM subscription key OR Front Door secret; otherwise 403 -->\n      <otherwise>\n        <choose>\n          <when condition='@(context.Subscription != null || context.Request.Headers.GetValueOrDefault(\"x-edge-secret\", \"\") == \"AFDEDGESECRET-20251028\")'>\n            <!-- If subscription present, stamp it for backend wallet resolution -->\n            <choose>\n              <when condition='@(context.Subscription != null)'>\n                <set-header name=\"x-subscription-id\" exists-action=\"override\">\n                  <value>@(context.Subscription.Id)</value>\n                </set-header>\n              </when>\n            </choose>\n            <!-- Strip client-supplied wallet headers to prevent spoofing; backend resolves wallet via subscription document -->\n            <set-header name=\"x-wallet\" exists-action=\"override\"><value></value></set-header>\n            <set-header name=\"wallet\" exists-action=\"override\"><value></value></set-header>\n            <!-- Rewrite '/portalpay/api/*' to '/api/*' for backend -->\n            <choose>\n              <when condition='@(context.Request.OriginalUrl.Path.StartsWith(\"/portalpay\"))'>\n                <rewrite-uri template='@(context.Request.OriginalUrl.Path.Substring(10))' />\n              </when>\n              <otherwise>\n                <rewrite-uri template='@(context.Request.OriginalUrl.Path)' />\n              </otherwise>\n            </choose>\n            <!-- Explicitly set backend service URL to ensure forwarding -->\n            <set-backend-service base-url=\"https://payportal-hufedgdtabc4bdhf.eastus-01.azurewebsites.net\" />\n          </when>\n          <otherwise>\n            <return-response>\n              <set-status code=\"403\" reason=\"Forbidden\" />\n              <set-header name=\"Content-Type\" exists-action=\"override\">\n                <value>application/json</value>\n              </set-header>\n              <set-body>{\"error\":\"forbidden\",\"message\":\"Valid APIM subscription key required or request must originate from Front Door\"}</set-body>\n            </return-response>\n          </otherwise>\n        </choose>\n      </otherwise>\n    </choose>\n  </inbound>\n  <backend>\n    <forward-request />\n  </backend>\n  <outbound>\n    <base />\n  </outbound>\n  <on-error>\n    <base />\n  </on-error>\n</policies>\n"
  }
}
